name: Deploy to EC2

on:
   push:
      branches:
         - main

jobs:
   deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout Repository
           uses: actions/checkout@v4

         - name: Deploy to EC2 using Appleboy SSH
           uses: appleboy/ssh-action@v0.1.10
           env:
              EC2_HOST: ${{ secrets.EC2_HOST }}
           with:
              host: ${{ secrets.EC2_HOST }}
              username: ubuntu
              key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
              port: 22
              script: |
                 cd /home/ubuntu || exit

                 # Clone repo if it doesn't exist
                 if [ ! -d "reelserver" ]; then
                   git clone https://github.com/mizanmahi/reelserver.git
                 fi

                 cd reelserver
                 git pull origin main

                 # Install dependencies
                 ssh ubuntu@$EC2_HOST "cd ~/reelserver && export PATH=$PATH:/run/user/1000/fnm_multishells/112424_1734077954807/bin && yarn install --frozen-lockfile

                 # Run Docker Compose
                 ssh ubuntu@$EC2_HOST "cd ~/reelserver && export PATH=$PATH:/run/user/1000/fnm_multishells/112424_1734077954807/bin && docker-compose down
                 ssh ubuntu@$EC2_HOST "cd ~/reelserver && export PATH=$PATH:/run/user/1000/fnm_multishells/112424_1734077954807/bin && docker-compose up --build -d
                 ssh ubuntu@$EC2_HOST "cd ~/reelserver && export PATH=$PATH:/run/user/1000/fnm_multishells/112424_1734077954807/bin &&  docker image prune -f
